{% extends 'base.html' %}
{% load static %}

{% block content %}
<main class="lyear-layout-content">
  <style>
    /* å¡ç‰‡å’Œæ­¥éª¤æµç¨‹æ ·å¼ */
    .step-flow-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 20px;
      background: rgba(255,255,255,0.08);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.15);
      backdrop-filter: blur(4px);
    }
    .step-item {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      transition: all 0.4s ease;
    }
    .step-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.12);
      color: #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
      transition: all 0.3s ease;
    }
    .step-item.completed .step-icon {
      background-color: #4caf50;
      color: white;
      border-color: #4caf50;
    }
    .step-item.completed span {
      color: #4caf50;
      font-weight: 500;
    }
    .step-item.current .step-icon {
      background-color: #a5d6a7;
      color: #2e7d32;
      border-color: #a5d6a7;
    }
    .step-item.current span {
      color: #2e7d32;
      font-weight: bold;
    }
  </style>

   <div class="container" style="display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding-top: 6vh;">
    <div class="card p-5 shadow-lg" style="max-width: 720px; width: 100%; border-radius: 24px; background: rgba(255,255,255,0.12); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.15);">

      <!-- é¡¶éƒ¨ -->
      <div class="text-center mb-4">
        <i class="mdi mdi-upload mdi-48px mb-2" style="color: #2e7d32;"></i>
        <h3 class="font-weight-bold text-success">å®ä½“å…³ç³»æŠ½å–</h3>
        <p class="text-muted small">ä¸Šä¼ ç¯å¢ƒå½±å“è¯„ä»· PDF / TXT æ–‡ä»¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æå–å¹¶æ„å»ºçŸ¥è¯†å›¾è°±</p>
      </div>

      <!-- ä¸Šä¼ è¡¨å• -->
      <form enctype="multipart/form-data" id="upload-form">
        {% csrf_token %}
        <div id="dropZone" class="rounded-4 text-center mb-4 position-relative p-4" style="background: rgba(255,255,255,0.08); border: 2px dashed rgba(67,160,71,0.5); cursor: pointer;">
          <input type="file" id="fileInput" name="file" accept=".pdf,.txt" onchange="handleFileSelect()" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0;">
          <i class="mdi mdi-cloud-upload-outline" style="font-size: 48px; color: #66bb6a;"></i>
          <p class="mt-2 mb-1" style="color: #e8f5e9; font-weight: 500;">æ‹–æ‹½æ–‡ä»¶è‡³æ­¤ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
          <p id="fileHint" class="mt-2" style="color: #c8e6c9;">ä»…æ”¯æŒ <strong>.pdf</strong> / <strong>.txt</strong> æ ¼å¼</p>
          <p id="fileName" class="mt-2 text-success small"></p>
        </div>

        <button type="submit" class="btn btn-success btn-lg w-100 rounded-pill">ä¸Šä¼ å¹¶æŠ½å–</button>
      </form>

      <!-- ä¸Šä¼ è¿›åº¦æ¡ -->
      <div class="progress mt-4" style="height: 6px; display: none;" id="progressWrapper">
        <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
      </div>

      <!-- æŠ½å–æµç¨‹æ­¥éª¤ -->
      <div id="extractionSteps" class="step-flow-container mt-4" style="display: none;">
        <div class="step-item" data-step="ğŸ“„ ä¸Šä¼ æˆåŠŸ">
          <div class="step-icon">1</div><span>ğŸ“„ ä¸Šä¼ æˆåŠŸ</span>
        </div>
        <div class="step-item" data-step="âœ‚ï¸ æ­£åœ¨æŠ½å–ä¸‰å…ƒç»„">
          <div class="step-icon">2</div><span>âœ‚ï¸ æ­£åœ¨æŠ½å–ä¸‰å…ƒç»„</span>
        </div>
        <div class="step-item" data-step="ğŸ§  æ­£åœ¨å†™å…¥å›¾è°±">
          <div class="step-icon">3</div><span>ğŸ§  æ­£åœ¨å†™å…¥å›¾è°±</span>
        </div>
        <div class="step-item" data-step="âœ… æŠ½å–æµç¨‹å®Œæˆ">
          <div class="step-icon"><i class="mdi mdi-check"></i></div><span>âœ… æŠ½å–æµç¨‹å®Œæˆ</span>
        </div>
      </div>

      <!-- æŠ½å–ç»“æœå±•ç¤ºåŒº -->
      <div id="extractionResultsContainer" class="mt-5" style="display: none;">
        <h5 class="text-success mb-3">ğŸ“š æŠ½å–ç»“æœ</h5>
        <div class="table-responsive">
          <table class="table table-striped table-hover table-bordered small" style="background: rgba(255,255,255,0.08); backdrop-filter: blur(4px); border-radius: 12px;">
            <thead class="thead-light">
              <tr>
                <th>æºå®ä½“ (source)</th>
                <th>ç›®æ ‡å®ä½“ (target)</th>
                <th>å…³ç³»ç±»å‹ (rel_type)</th>
                <th>åŸæ–‡ç‰‡æ®µ (source_text)</th>
              </tr>
            </thead>
            <tbody id="extractionResultsBody">
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</main>


<script src="{% static 'jquery-1.10.2.min.js' %}"></script>
<script>
$(document).ready(function () {
  $.get('/progress', function (res) {
    if (res.state && res.state !== "âœ… æŠ½å–æµç¨‹å®Œæˆ" && res.state !== "" && res.state !== "âŒ› ç­‰å¾…å¼€å§‹...") {
      $('#extractionSteps').show();
      startProgressPolling();
    }
  });
});
function displayExtractionResult(data) {
  const container = document.createElement('div');
  container.className = "mt-4 p-3 rounded-3";
  container.style.background = "rgba(255,255,255,0.12)";
  container.style.backdropFilter = "blur(6px)";
  container.style.border = "1px solid rgba(255,255,255,0.15)";

  const title = document.createElement('h5');
  title.textContent = "ğŸ¯ æŠ½å–å®Œæˆç»“æœï¼š";
  title.style.color = "#4caf50";
  container.appendChild(title);

  const list = document.createElement('ul');
  list.style.listStyle = "none";
  list.style.padding = "0";

  data.forEach(item => {
    const li = document.createElement('li');
    li.innerHTML = `ğŸ”¹ <b>${item.source}</b> â€” <b>${item.rel_type}</b> â€”> <b>${item.target}</b>`;
    list.appendChild(li);
  });

  container.appendChild(list);   // âœ… åªè¿™é‡Œ append ä¸€æ¬¡
  document.querySelector('.card').appendChild(container);
}


function validateFile(file) {
  const allowedExtensions = ['pdf', 'txt'];
  if (!file) return false;
  const extension = file.name.split('.').pop().toLowerCase();
  return allowedExtensions.includes(extension);
}

function handleFileSelect() {
  const file = document.getElementById('fileInput').files[0];
  if (file && validateFile(file)) {
    document.getElementById('fileName').textContent = `å·²é€‰æ‹©æ–‡ä»¶: ${file.name}`;
  } else {
    alert('âŒ ä»…æ”¯æŒ PDF æˆ– TXT æ–‡ä»¶ï¼Œè¯·é‡æ–°é€‰æ‹©ï¼');
    document.getElementById('fileInput').value = '';
    document.getElementById('fileName').textContent = '';
  }
}

// æ‹–æ‹½åŒºåŸŸé«˜äº®
const dropZone = document.getElementById('dropZone');
['dragover', 'dragenter'].forEach(evt => {
  dropZone.addEventListener(evt, e => {
    e.preventDefault();
    dropZone.style.borderColor = '#81c784';
  });
});
['dragleave', 'drop'].forEach(evt => {
  dropZone.addEventListener(evt, e => {
    e.preventDefault();
    dropZone.style.borderColor = 'rgba(67,160,71,0.5)';
  });
});
dropZone.addEventListener('drop', e => {
  const file = e.dataTransfer.files[0];
  if (file && validateFile(file)) {
    document.getElementById('fileInput').files = e.dataTransfer.files;
    document.getElementById('fileName').textContent = `å·²é€‰æ‹©æ–‡ä»¶: ${file.name}`;
  } else {
    alert('âŒ è¯·ä¸Šä¼  PDF æˆ– TXT æ ¼å¼æ–‡ä»¶');
    document.getElementById('fileName').textContent = '';
  }
});

// è½®è¯¢æµç¨‹è¿›åº¦
function startProgressPolling() {
  const steps = document.querySelectorAll('.step-item');
  const stepMap = {
    "ğŸ“„ ä¸Šä¼ æˆåŠŸ": 0,
    "âœ‚ï¸ æ­£åœ¨æŠ½å–ä¸‰å…ƒç»„": 1,
    "ğŸ§  æ­£åœ¨å†™å…¥å›¾è°±": 2,
    "âœ… æŠ½å–æµç¨‹å®Œæˆ": 3
  };

  $('#extractionSteps').show();

  let polling = setInterval(() => {
    $.get('/progress', function (res) {
      const index = stepMap[res.state];

      if (index !== undefined) {
        steps.forEach((step, i) => {
          step.classList.remove('completed', 'current');
          if (i < index) {
            step.classList.add('completed');
          } else if (i === index) {
            step.classList.add('current');
          }
        });

        if (index === 3) {  // åˆ°æœ€åä¸€æ­¥
          clearInterval(polling);
          fetchExtractionResults();  // å»è¯·æ±‚ç»“æœ
        }
      }
    });
  }, 500); // æ¯0.5ç§’è½®è¯¢ä¸€æ¬¡
}


// ä¸Šä¼ è¡¨å•æäº¤
$('#upload-form').submit(function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  const btn = $(this).find('button[type="submit"]');
  const fileInput = document.getElementById('fileInput');

  // å¼€å§‹ä¸Šä¼ ï¼ŒæŒ‰é’®loading
  btn.html(`<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> æ­£åœ¨æŠ½å–...`);
  btn.prop('disabled', true);
  fileInput.disabled = true;

  $('#progressWrapper').show();
  $('#progressBar').css('width', '0%');

  $.ajax({
    url: '/upload',
    type: 'POST',
    data: formData,
    processData: false,
    contentType: false,
    xhr: function () {
      let xhr = new window.XMLHttpRequest();
      xhr.upload.addEventListener("progress", function (evt) {
        if (evt.lengthComputable) {
          let percent = (evt.loaded / evt.total) * 100;
          $('#progressBar').css('width', percent.toFixed(2) + '%');
        }
      }, false);
      return xhr;
    },
    success: function (response) {
      if (response.status === 'success') {
        // ä¸Šä¼ æˆåŠŸåå†å¯åŠ¨è½®è¯¢
        startProgressPolling();
      } else {
        alert('âŒ ä¸Šä¼ å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'));
      }
    },
    error: function (xhr) {
      alert('âŒ ä¸Šä¼ å‡ºé”™: ' + xhr.responseText);
    },
    complete: function () {
      // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œæœ€åæ¢å¤æŒ‰é’®
      btn.html('ä¸Šä¼ å¹¶æŠ½å–');
      btn.prop('disabled', false);
      fileInput.disabled = false;
      $('#progressWrapper').hide();
      $('#progressBar').css('width', '0%');
      document.getElementById('fileInput').value = '';
      document.getElementById('fileName').textContent = '';
    }
  });
});

  function fetchExtractionResults() {
  $.get('/get_extraction_result', function (res) {
    if (res.data && res.data.length > 0) {
      $('#extractionResultsContainer').show();
      const tbody = $('#extractionResultsBody');
      tbody.empty();

      res.data.forEach(row => {
        tbody.append(`
          <tr>
            <td>${row.source || ''}</td>
            <td>${row.target || ''}</td>
            <td>${row.rel_type || ''}</td>
            <td>${row.source_text || ''}</td>
          </tr>
        `);
      });
    } else {
      console.log('âš ï¸ æš‚æ— æŠ½å–ç»“æœ');
    }
  });
}

</script>
{% endblock %}
