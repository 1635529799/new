{% extends 'base.html' %}
{% load static %}

{% block content %}
<main class="lyear-layout-content">
  <style>
    .step-flow-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 20px;
      background: rgba(255,255,255,0.08);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.15);
      backdrop-filter: blur(4px);
    }

    .step-item {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      transition: all 0.4s ease;
    }

    .step-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.12);
      color: #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .step-item.completed .step-icon {
      background-color: #4caf50;
      color: white;
      border-color: #4caf50;
    }

    .step-item.completed span {
      color: #4caf50;
      font-weight: 500;
    }

    .step-item.current .step-icon {
      background-color: #a5d6a7;
      color: #2e7d32;
      border-color: #a5d6a7;
    }

    .step-item.current span {
      color: #2e7d32;
      font-weight: bold;
    }
  </style>

  <div class="container" style="display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding-top: 6vh;">
    <div class="card p-5 shadow-lg" style="max-width: 720px; width: 100%; border-radius: 24px; background: rgba(255,255,255,0.12); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.15);">
      <div class="text-center mb-4">
        <i class="mdi mdi-upload mdi-48px mb-2" style="color: #2e7d32;"></i>
        <h3 class="font-weight-bold text-success">å®ä½“å…³ç³»æŠ½å–</h3>
        <p class="text-muted small">ä¸Šä¼ ç¯å¢ƒå½±å“è¯„ä»· PDF æ–‡ä»¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æå–å¹¶æ„å»ºçŸ¥è¯†å›¾è°±</p>
      </div>

      <form enctype="multipart/form-data">
        {% csrf_token %}
        <div id="dropZone" class="rounded-4 text-center mb-4 position-relative p-4"
             style="background: rgba(255,255,255,0.08); border: 2px dashed rgba(67,160,71,0.5); cursor: pointer;">
          <input type="file" id="fileInput" name="file" accept="application/pdf"
                 onchange="handleFileSelect()"
                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0;">
          <i class="mdi mdi-cloud-upload-outline" style="font-size: 48px; color: #66bb6a;"></i>
          <p class="mt-2 mb-1 text-white">æ‹–æ‹½æ–‡ä»¶è‡³æ­¤ï¼Œæˆ–ç‚¹å‡»é€‰æ‹© PDF</p>
          <button type="button" class="btn btn-outline-success mb-2 rounded-pill px-4 py-2">
            <i class="mdi mdi-file-upload-outline mr-1"></i> é€‰æ‹©æ–‡ä»¶
          </button>
          <p id="fileName" class="mt-3 text-light small">ä»…æ”¯æŒ PDF æ ¼å¼</p>
        </div>

        <button type="submit" class="btn btn-success btn-lg w-100 rounded-pill">ä¸Šä¼ å¹¶æŠ½å–</button>
      </form>

      <div class="progress mt-4" style="height: 6px; display: none;" id="progressWrapper">
        <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
      </div>

      <div id="extractionSteps" class="step-flow-container mt-4" style="display: none;">
        <div class="step-item" data-step="ğŸ“„ ä¸Šä¼ æˆåŠŸ">
          <div class="step-icon">1</div><span>ğŸ“„ ä¸Šä¼ æˆåŠŸ</span>
        </div>
        <div class="step-item" data-step="âœ‚ï¸ æ­£åœ¨æŠ½å–ä¸‰å…ƒç»„">
          <div class="step-icon">2</div><span>âœ‚ï¸ æ­£åœ¨æŠ½å–ä¸‰å…ƒç»„</span>
        </div>
        <div class="step-item" data-step="ğŸ§  æ­£åœ¨å†™å…¥å›¾è°±">
          <div class="step-icon">3</div><span>ğŸ§  æ­£åœ¨å†™å…¥å›¾è°±</span>
        </div>
        <div class="step-item" data-step="âœ… æŠ½å–æµç¨‹å®Œæˆ">
          <div class="step-icon"><i class="mdi mdi-check"></i></div><span>âœ… æŠ½å–æµç¨‹å®Œæˆ</span>
        </div>
      </div>
    </div>
  </div>
</main>

<script src="{% static 'jquery-1.10.2.min.js' %}"></script>
<script>
  function handleFileSelect() {
    const file = fileInput.files[0];
    if (validatePDF(file)) displayFileName(file);
    else {
      alert('ä»…å¯ä¸Šä¼  PDF æ–‡ä»¶');
      fileInput.value = '';
      displayFileName();
    }
  }
  $(document).ready(function () {
  console.log("ğŸ“Œ é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æ¢å¤æµç¨‹è½®è¯¢");

  $.get('/progress', function (res) {
    console.log("ğŸŒ è·å–åˆ°çŠ¶æ€ï¼š", res.state);
    if (res.state && res.state !== "âœ… æŠ½å–æµç¨‹å®Œæˆ" && res.state !== "" && res.state !== "âŒ› ç­‰å¾…å¼€å§‹...") {
      console.log("ğŸ” çŠ¶æ€éœ€è¦æ¢å¤ï¼Œå¯åŠ¨è½®è¯¢...");
      $('#extractionSteps').show();
      startProgressPolling();
    } else {
      console.log("âŒ çŠ¶æ€ä¸ºç©ºæˆ–å·²å®Œæˆï¼Œæ— éœ€æ¢å¤ã€‚");
    }
  });
});
  function startProgressPolling() {
  console.log("ğŸ“¡ å·²å¯åŠ¨è½®è¯¢å‡½æ•°...");
  const steps = $('#stepFlow li');

}

  function validatePDF(file) {
    return file && file.type === 'application/pdf';
  }

  function displayFileName(file = null) {
    document.getElementById('fileName').textContent = file ? file.name : 'ä»…æ”¯æŒ PDF æ ¼å¼';
  }
  function handleFileSelect() {
    const file = document.getElementById('fileInput').files[0];
    if (validatePDF(file)) {
      displayFileName(file);
    } else {
      alert('ä»…å¯ä¸Šä¼  PDF æ–‡ä»¶');
      document.getElementById('fileInput').value = '';
      displayFileName();
    }
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');


  }
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    if (validatePDF(file)) {
      fileInput.files = e.dataTransfer.files;
      displayFileName(file);
    } else {
      alert('è¯·ä¸Šä¼  PDF æ ¼å¼çš„æ–‡ä»¶');
    }
  });

  ['dragover', 'dragenter'].forEach(evt => {
    dropZone.addEventListener(evt, e => {
      e.preventDefault();
      dropZone.style.borderColor = '#81c784';
    });
  });
  ['dragleave'].forEach(evt => {
    dropZone.addEventListener(evt, e => {
      e.preventDefault();
      dropZone.style.borderColor = 'rgba(67,160,71,0.5)';
    });
  });



  function startProgressPolling() {
    const steps = document.querySelectorAll('.step-item');
    const stepMap = {
      "ğŸ“„ ä¸Šä¼ æˆåŠŸ": 0,
      "âœ‚ï¸ æ­£åœ¨æŠ½å–ä¸‰å…ƒç»„": 1,
      "ğŸ§  æ­£åœ¨å†™å…¥å›¾è°±": 2,
      "âœ… æŠ½å–æµç¨‹å®Œæˆ": 3
    };

    $('#extractionSteps').show();

    let polling = setInterval(() => {
      $.get('/progress', function (res) {
        const index = stepMap[res.state];
        if (index !== undefined) {
          steps.forEach((step, i) => {
            step.classList.remove('completed', 'current');
            if (i < index) step.classList.add('completed');
            else if (i === index) step.classList.add('current');
          });
          if (index === 3) clearInterval(polling);
        }
      });
    }, 1000);
  }

  $('form').submit(function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const btn = $(this).find('button[type="submit"]');

    btn.html(`<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> æ­£åœ¨æŠ½å–...`);
    btn.prop('disabled', true);
    $('#progressWrapper').show();
    $('#progressBar').css('width', '0%');
    startProgressPolling();

    $.ajax({
      url: '/upload',
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      xhr: function () {
        let xhr = new window.XMLHttpRequest();
        xhr.upload.addEventListener("progress", function (evt) {
          if (evt.lengthComputable) {
            let percent = (evt.loaded / evt.total) * 100;
            $('#progressBar').css('width', percent.toFixed(2) + '%');
          }
        }, false);
        return xhr;
      },
      success: function (response) {
        btn.html('ä¸Šä¼ å¹¶æŠ½å–');
        btn.prop('disabled', false);
        $('#progressWrapper').hide();
        $('#progressBar').css('width', '0%');
        fileInput.value = '';
        displayFileName();
      },
      error: function (xhr) {
        btn.html('ä¸Šä¼ å¹¶æŠ½å–');
        btn.prop('disabled', false);
        $('#progressWrapper').hide();
        $('#progressBar').css('width', '0%');
        alert('ä¸Šä¼ å¤±è´¥: ' + xhr.responseText);
      }
    });
  });
</script>
{% endblock %}
